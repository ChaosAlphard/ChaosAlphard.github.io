---
title: '[记录]一些小知识点'
date: 2018-08-12 18:20:20
tags: [Note]
---

# ajax发送请求服务器端页面转发问题
ajax发送请求的类中，requestDispatcher和sendRedirect都无法转发或重定向页面。

因为ajax请求的方法中不能进行转发或重定向。

# Servlet中response.addCookie()无效
示例:
```java
PrintWriter out = response.getWriter();
out.close();
Cookie c = new Cookie("uid", "12450");
c.setMaxAge(3600);
response.addCookie(c);
```

<!-- more -->

原因:  
`PrintWriter`的`close()`方法会使`isCommitted`的值变为`True`。  
所以，在`PrintWriter`调用`close()`之后，`addCookie()`方法会失效。

`addCookie()`源码片段:
```java
public void addCookie(Cookie cookie) {
    if (isCommitted()){
        return;
    }
    response.addCookie(cookie);
}
```

参考  
> https://blog.csdn.net/xunmi1983/article/details/25309763


# Tomcat 9.0.10 停止服务器时的警告问题
## 信息

```
信息 [main] org.apache.catalina.core.StandardServer.await A valid shutdown command was received via the shutdown port. Stopping the Server instance.
信息 [main] org.apache.coyote.AbstractProtocol.pause Pausing ProtocolHandler ["http-nio-8080"]
信息 [main] org.apache.coyote.AbstractProtocol.pause Pausing ProtocolHandler ["ajp-nio-8009"]
信息 [main] org.apache.catalina.core.StandardService.stopInternal Stopping service [Catalina]
警告 [main] org.apache.catalina.loader.WebappClassLoaderBase.clearReferencesJdbc The web application [ROOT] registered the JDBC driver [com.mysql.jdbc.Driver] but failed to unregister it when the web application was stopped. To prevent a memory leak, the JDBC Driver has been forcibly unregistered.
警告 [main] org.apache.catalina.loader.WebappClassLoaderBase.clearReferencesThreads The web application [ROOT] appears to have started a thread named [Abandoned connection cleanup thread] but has failed to stop it. This is very likely to create a memory leak. Stack trace of thread:
java.lang.Object.wait(Native Method)
java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:143)
com.mysql.jdbc.AbandonedConnectionCleanupThread.run(AbandonedConnectionCleanupThread.java:64)
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
java.lang.Thread.run(Thread.java:748)
信息 [main] org.apache.coyote.AbstractProtocol.stop Stopping ProtocolHandler ["http-nio-8080"]
信息 [main] org.apache.coyote.AbstractProtocol.stop Stopping ProtocolHandler ["ajp-nio-8009"]
信息 [main] org.apache.coyote.AbstractProtocol.destroy Destroying ProtocolHandler ["http-nio-8080"]
信息 [main] org.apache.coyote.AbstractProtocol.destroy Destroying ProtocolHandler ["ajp-nio-8009"]
```

## 原因
>web应用程序[ROOT]注册了JDBC驱动程序[com.mysql.jdbc]。但是，当web应用程序停止时，未能注销它。为了防止内存泄漏，JDBC驱动程序已强制取消注册。

这是由于在停止Tomcat 服务器时没有注销JDBC驱动导致的

## 解决
在服务器关闭时对JDBC驱动进行注销
```java
try {
    DriverManager.deregisterDriver(DriverManager.getDriver(url));
} catch (SQLException e) {
    System.out.println("注销失败");
    e.printStackTrace();
}
```